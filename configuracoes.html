<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configura√ß√µes - Rosarium</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Script de seguran√ßa -->
  <script>
    function goBack() {
      // Se houver hist√≥rico, volta. Se n√£o houver, vai para home
      if (document.referrer && history.length > 1) {
        history.back();
      } else {
        window.location.href = "home.html";
      }
    }
  </script>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <button class="btn-back" onclick="goBack()">‚Üê Voltar</button>
      <div class="header-title">
        <div class="header-logo">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </div>
        <span>Configura√ß√µes</span>
      </div>
    </div>
  </header>

  <script src="app.js"></script>

  <div class="page-container">
    <div class="page-content container-md">
      <h1 class="page-title">Configura√ß√µes</h1>

      <!-- Seguran√ßa -->
      <div class="card" style="margin-bottom: 2rem;">
        <h3 class="card-title">Seguran√ßa</h3>
        <div class="card-content">
          <div class="form-group">
            <label class="label">PIN Atual (4 d√≠gitos):</label>
            <input type="password" class="input" id="current-pin" placeholder="Digite seu PIN atual" maxlength="4">
          </div>
          
          <div class="form-group">
            <label class="label">Novo PIN (4 d√≠gitos):</label>
            <input type="password" class="input" id="new-pin" placeholder="Digite o novo PIN" maxlength="4">
          </div>
          
          <div class="form-group">
            <label class="label">Confirmar PIN:</label>
            <input type="password" class="input" id="confirm-pin" placeholder="Confirme o novo PIN" maxlength="4">
          </div>
          
          <button class="btn" onclick="changePin()" style="width: 100%;">Alterar PIN</button>
        </div>
      </div>

      <!-- Dados -->
      <div class="card" style="margin-bottom: 2rem;">
        <h3 class="card-title">Dados e Privacidade</h3>
        <div class="card-content">
          <p style="margin-bottom: 1rem; color: var(--muted-foreground);">
            Seus dados s√£o salvos apenas no seu dispositivo.
          </p>
          
          <button class="btn btn-outline" onclick="exportData()" style="width: 100%; margin-bottom: 1rem;">
            Exportar Dados
          </button>
          
          <button class="btn btn-outline" onclick="clearAllData()" style="width: 100%; color: var(--destructive);">
            Limpar Todos os Dados
          </button>
        </div>
      </div>

      <!-- Sobre -->
      <div class="card">
        <h3 class="card-title">Sobre</h3>
        <div class="card-content">
          <p><strong>Rosarium</strong></p>
          <p style="color: var(--muted-foreground); margin-bottom: 1rem;">v1.0.0</p>
          <p>Aplicativo cat√≥lico para ora√ß√£o, estudos e devo√ß√£o di√°ria.</p>
        </div>
      </div>

    </div>
  </div>

  <script>

    // üîê CORRE√á√ÉO COMPLETA DO PIN
    function changePin() {
      const currentPin = document.getElementById('current-pin').value.trim();
      const newPin = document.getElementById('new-pin').value.trim();
      const confirmPin = document.getElementById('confirm-pin').value.trim();

      if (!currentPin || !newPin || !confirmPin) {
        alert("Preencha todos os campos.");
        return;
      }

      if (!PIN.verify(currentPin)) {
        alert("PIN atual incorreto.");
        return;
      }

      if (newPin.length !== 4 || confirmPin.length !== 4 || isNaN(newPin) || isNaN(confirmPin)) {
        alert("O PIN deve ter 4 n√∫meros.");
        return;
      }

      if (newPin !== confirmPin) {
        alert("Os PINs n√£o coincidem.");
        return;
      }

      // salva como string garantida
      PIN.setPin(String(newPin));

      alert("PIN alterado com sucesso!");

      document.getElementById('current-pin').value = "";
      document.getElementById('new-pin').value = "";
      document.getElementById('confirm-pin').value = "";
    }


    function exportData() {
      const data = {
        terco: Terco.getTercoCalendar(),
        anotacoes: Anotacoes.getAnotacoes(),
        confissoes: Confissao.getConfissoes(),
        exportDate: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(data, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = "rosarium-dados.json";
      link.click();

      URL.revokeObjectURL(url);
    }


    function clearAllData() {
      if (!confirm("Deseja realmente apagar todos os dados?")) return;
      localStorage.clear();
      alert("Dados apagados.");
      window.location.href = "home.html";
    }

  </script>

</body>
</html>
