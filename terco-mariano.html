<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Terço Mariano - Rosarium</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* estilos embutidos (mantidos do original) */
    :root{--primary:#4360C6;--bg:#FCFAFB;--text:#121212;--muted:#666;--icon:#4D3E43}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial}
    .header{display:flex;align-items:center;padding:12px 16px;gap:.6rem}
    .btn-back{background:transparent;border:none;cursor:pointer;color:var(--text);font-size:1rem}
    .header-title{display:flex;align-items:center;gap:.6rem;font-weight:700}
    .page-container{max-width:760px;margin:1.25rem auto;padding:0 16px}
    .card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.04);margin-bottom:12px}
    .prayer-card{padding:14px}
    .prayer-card h3{margin:0 0 6px 0}
    .prayer-card p{margin:0;line-height:1.6}
    .prayer-meta{color:var(--muted);margin-top:8px;font-size:.95rem}
    .misterio-box{background:#eef6ff;border-left:4px solid var(--primary);padding:10px;border-radius:8px;margin-bottom:12px;display:none}
    .misterio-box strong{display:block;margin-bottom:.25rem}
    .counter{ text-align:center; padding:12px }
    .counter-display{ font-weight:700; font-size:1.4rem }
    .small-muted{ color:var(--muted); font-size:.95rem }
    .beads-container{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:12px 0}
    .bead{ display:inline-flex; align-items:center; justify-content:center; user-select:none; cursor:pointer; background:#fbfbfb; color:var(--icon); box-shadow:0 1px 3px rgba(0,0,0,0.04); }
    .bead.am{ width:34px; height:34px; border-radius:50%; font-weight:600 }       
    .bead.pn{ width:44px; height:44px; border-radius:50%; font-weight:700 }
    .bead.credo{ width:44px; height:44px; border-radius:50%; font-weight:700; font-size:1.2rem }
    .bead.filled{ background:var(--primary); color:#fff; box-shadow:0 6px 14px rgba(67,96,198,0.18) }
    .progress-bar{height:8px;background:#eee;border-radius:999px;overflow:hidden;margin:8px 18px}
    .progress-fill{height:100%;width:0;background:var(--primary);transition:width .25s ease}
    .buttons{display:flex;gap:.6rem;justify-content:center;margin-top:8px;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:10px;border:none;background:var(--primary);color:#fff;cursor:pointer;font-weight:700}
    .btn-outline{background:transparent;border:1px solid #ddd;color:var(--text)}
    @media (max-width:420px){ .bead.am{width:30px;height:30px} .bead.pn{width:38px;height:38px} .bead.credo{width:38px;height:38px} .counter-display{font-size:1.15rem} }
  </style>
</head>
<body>
  <header class="header">
    <button class="btn-back" onclick="history.back()">← Voltar</button>
    <div class="header-title" aria-hidden="false">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span>Terço Mariano</span>
    </div>
  </header>

  <main class="page-container">
    <div class="card prayer-card" id="prayerCard" role="region" aria-live="polite">
      <h3 id="prayerTitle">Oração atual</h3>
      <p id="prayerText">Carregando...</p>
      <div class="prayer-meta" id="prayerMeta"></div>
    </div>

    <div id="misterioBox" class="misterio-box" aria-hidden="true">
      <strong id="misterioTitle"></strong>
      <div id="misterioText"></div>
    </div>

    <div class="card counter" role="group" aria-labelledby="tercoStatus">
      <div id="counterDisplay" class="counter-display">0 / 0</div>
      <div class="small-muted" id="tercoStatus">Progresso do Terço Mariano</div>

      <div id="beadsContainer" class="beads-container" aria-hidden="false"></div>

      <div class="progress-bar" aria-hidden="false">
        <div id="progressFill" class="progress-fill" style="width:0%"></div>
      </div>
      <div id="progressLabel" class="small-muted" style="margin-top:6px">0%</div>

      <div class="buttons">
        <button class="btn" id="btnNext" aria-label="Próxima oração">+ Próxima</button>
        <button class="btn btn-outline" id="btnReset" aria-label="Resetar o terço">Resetar</button>
      </div>
    </div>
  </main>

  <!-- carrega app.js que fornece window.registrarTercoRezados e window.Terco -->
  <script src="app.js"></script>

  <script>
  /* Terço Mariano — baseado no seu código anterior, somente com a chamada de registro ao final. */

  const ORACOES = {
    sinal_da_cruz: "Em nome do Pai, do Filho e do Espírito Santo. Amém.",
    credo: "Creio em Deus Pai todo-poderoso, criador do céu e da terra; ... Amém.",
    pai_nosso: "Pai nosso, que estais nos céus... Amém.",
    ave_maria: "Ave Maria, cheia de graça... Amém.",
    gloria: "Glória ao Pai, e ao Filho, e ao Espírito Santo. Amém.",
    salve_rainha: "Salve Rainha, Mãe de Misericórdia... Amém."
  };

  const MISTERIOS = {
    gozosos: [ "1º Mistério Gozoso — A Anunciação", "2º ...", "3º ...", "4º ...", "5º ..." ],
    luminosos: [ "1º ...", "2º ...", "3º ...", "4º ...", "5º ..." ],
    dolorosos: [ "1º ...", "2º ...", "3º ...", "4º ...", "5º ..." ],
    gloriosos: [ "1º ...", "2º ...", "3º ...", "4º ...", "5º ..." ]
  };

  const SEQUENCE = (function(){
    const s = [];
    s.push('sinal');
    s.push('credo');
    s.push('pn');
    s.push('am','am','am');
    s.push('gl');
    for(let d=0; d<5; d++){
      s.push('pn');
      for(let i=0;i<10;i++) s.push('am');
      s.push('gl');
    }
    s.push('salve');
    return s;
  })();

  const STORAGE_KEY = 'rosarium_terco_mariano_v4';
  let state = { stepIndex: 0 };

  function loadState(){
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) state = JSON.parse(raw);
    } catch(e) { console.warn('loadState err', e); }
  }
  function saveState(){
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e){ console.warn('saveState err', e); }
  }

  function getMisterioInfo(){
    const d = new Date().getDay();
    if (d === 1 || d === 6) return { key: 'gozosos', label: 'Mistérios Gozosos' };
    if (d === 2 || d === 5) return { key: 'dolorosos', label: 'Mistérios Dolorosos' };
    if (d === 4) return { key: 'luminosos', label: 'Mistérios Luminosos' };
    return { key: 'gloriosos', label: 'Mistérios Gloriosos' };
  }

  function countAMUpTo(stepIndex){
    let c = 0;
    for(let i=0;i<=stepIndex;i++) if(SEQUENCE[i] === 'am') c++;
    return c;
  }

  function buildBeadSteps(){
    const arr = [];
    for(let i=0;i<SEQUENCE.length;i++){
      if(SEQUENCE[i] === 'pn' || SEQUENCE[i] === 'am' || SEQUENCE[i] === 'credo') arr.push({ stepIndex: i, type: SEQUENCE[i] });
    }
    return arr;
  }

  function computeMysteryIndexForStep(stepIndex){
    let count = 0;
    for(let i=0;i<=stepIndex;i++){
      if(SEQUENCE[i] === 'pn' && SEQUENCE[i-1] === 'gl') count++;
    }
    return count - 1;
  }

  function render(){
    const step = SEQUENCE[state.stepIndex];
    const prayerTitleEl = document.getElementById('prayerTitle');
    const prayerTextEl  = document.getElementById('prayerText');
    const prayerMetaEl  = document.getElementById('prayerMeta');
    const misterioBox    = document.getElementById('misterioBox');
    const misterioTitle  = document.getElementById('misterioTitle');
    const misterioText   = document.getElementById('misterioText');

    misterioBox.style.display = 'none';
    misterioTitle.innerText = '';
    misterioText.innerText = '';

    if(step === 'sinal'){
      prayerTitleEl.innerText = 'Sinal da Cruz';
      prayerTextEl.innerText = ORACOES.sinal_da_cruz;
      prayerMetaEl.innerText = '';
    } else if(step === 'credo'){
      prayerTitleEl.innerText = 'Creio';
      prayerTextEl.innerText = ORACOES.credo;
      prayerMetaEl.innerText = '';
    } else if(step === 'pn'){
      prayerTitleEl.innerText = 'Pai-Nosso';
      prayerTextEl.innerText = ORACOES.pai_nosso;
      const isDezenaPN = SEQUENCE[state.stepIndex - 1] === 'gl';
      if(isDezenaPN){
        const info = getMisterioInfo();
        const mIndex = computeMysteryIndexForStep(state.stepIndex);
        if(mIndex >= 0 && mIndex < 5){
          misterioBox.style.display = 'block';
          misterioTitle.innerText = `${info.label} — ${mIndex + 1}º`;
          misterioText.innerText = MISTERIOS[info.key][mIndex];
        }
        prayerMetaEl.innerText = `Pai-Nosso da dezena ${computeMysteryIndexForStep(state.stepIndex) + 1}`;
      } else {
        prayerMetaEl.innerText = '';
      }
    } else if(step === 'am'){
      prayerTitleEl.innerText = 'Ave-Maria';
      prayerTextEl.innerText = ORACOES.ave_maria;
      const amSoFar = countAMUpTo(state.stepIndex);
      prayerMetaEl.innerText = `Ave-Maria ${amSoFar} de 50`;
    } else if(step === 'gl'){
      prayerTitleEl.innerText = 'Glória ao Pai';
      prayerTextEl.innerText = ORACOES.gloria;
      prayerMetaEl.innerText = '';
    } else if(step === 'salve'){
      prayerTitleEl.innerText = 'Salve Rainha';
      prayerTextEl.innerText = ORACOES.salve_rainha;
      prayerMetaEl.innerText = '';
    } else {
      prayerTitleEl.innerText = '';
      prayerTextEl.innerText = '';
      prayerMetaEl.innerText = '';
    }

    document.getElementById('counterDisplay').innerText = `${state.stepIndex + 1} / ${SEQUENCE.length}`;

    const beadsContainer = document.getElementById('beadsContainer');
    beadsContainer.innerHTML = '';
    const beadSteps = buildBeadSteps();

    let lastFilledGlobal = -1;
    for(let j=0;j<=state.stepIndex;j++){
      if(SEQUENCE[j] === 'pn' || SEQUENCE[j] === 'am' || SEQUENCE[j] === 'credo') lastFilledGlobal = j;
    }

    beadSteps.forEach((b, idx) => {
      const div = document.createElement('div');
      
      if(b.type === 'credo'){
        div.className = 'bead credo';
        div.innerText = '✝';
      } else if(b.type === 'pn'){
        div.className = 'bead pn pai-nosso-bead';
        div.innerText = 'P';
      } else {
        div.className = 'bead am';
      }
      
      if(b.stepIndex <= lastFilledGlobal) div.classList.add('filled');
      div.title = `${b.type === 'pn' ? 'Pai-Nosso' : b.type === 'credo' ? 'Creio' : 'Ave-Maria'} — passo ${b.stepIndex + 1}`;
      div.onclick = () => jumpTo(b.stepIndex);
      beadsContainer.appendChild(div);
    });

    const pct = Math.round(((state.stepIndex + 1) / SEQUENCE.length) * 100);
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressLabel').innerText = pct + '%';

    misterioBox.setAttribute('aria-hidden', misterioBox.style.display === 'none' ? 'true' : 'false');
  }

  function onTercoComplete(){
    // registra no calendário usando a função global do app.js
    try {
      if (typeof registrarTercoRezados === 'function') {
        registrarTercoRezados('mariano');
      } else if (window.Terco && window.Terco.record) {
        window.Terco.record('mariano');
      } else {
        console.warn('Nenhuma função de registro disponível.');
      }
    } catch (e) {
      console.error('Erro ao registrar terço completo', e);
    }
  }

  function nextStep(){
    if(state.stepIndex >= SEQUENCE.length - 1){
      alert('Terço completo — Glória a Deus!');

      // registrar antes do reset
      onTercoComplete();

      setTimeout(() => {
        state = { stepIndex: 0 };
        saveState();
        render();
      }, 750);

      return;
    }
    state.stepIndex++;
    saveState();
    render();
  }

  function resetTerco(){
    if(!confirm('Deseja resetar o Terço Mariano?')) return;
    state = { stepIndex: 0 };
    saveState();
    render();
  }

  function jumpTo(globalStepIndex){
    if(typeof globalStepIndex !== 'number') return;
    if(globalStepIndex < 0 || globalStepIndex >= SEQUENCE.length) return;
    state.stepIndex = globalStepIndex;
    saveState();
    render();
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadState();
    if(typeof state.stepIndex !== 'number' || state.stepIndex < 0 || state.stepIndex >= SEQUENCE.length) state.stepIndex = 0;
    render();
    document.getElementById('btnNext').addEventListener('click', nextStep);
    document.getElementById('btnReset').addEventListener('click', resetTerco);
  });
  </script>
</body>
</html>