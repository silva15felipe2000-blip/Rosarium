<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Terço da Misericórdia - Rosarium</title>
<link rel="stylesheet" href="style.css">
<style>
  :root{ --primary:#4360C6; --bg:#FCFAFB; --text:#121212; --muted:#666; --icon:#4D3E43 }
  body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text)}
  .header{display:flex;align-items:center;padding:12px 16px;gap:.6rem}
  .btn-back{background:transparent;border:none;cursor:pointer;color:var(--text)}
  .page{max-width:760px;margin:1.2rem auto;padding:0 16px}
  .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.04);margin-bottom:12px}
  .prayer-card{padding:14px}
  .prayer-card h3{margin:0 0 .5rem 0}
  .prayer-meta{color:var(--muted);margin-top:.6rem;font-size:.95rem}
  .misterio{background:#eef6ff;border-left:4px solid var(--primary);padding:10px;border-radius:8px;margin-bottom:12px;display:none}
  .beads{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:12px 0}
  .bead{display:inline-flex;align-items:center;justify-content:center;user-select:none;cursor:pointer;background:#fbfbfb;color:var(--icon);box-shadow:0 1px 3px rgba(0,0,0,0.04)}
  .bead.am{width:34px;height:34px;border-radius:50%;font-weight:600}
  .bead.pn{width:44px;height:44px;border-radius:50%;font-weight:700}
  .bead.credo{width:44px;height:44px;border-radius:50%;font-weight:700;font-size:1.2rem}
  .bead.filled{background:var(--primary);color:#fff;box-shadow:0 6px 14px rgba(67,96,198,0.18)}
  .progress{height:8px;background:#eee;border-radius:999px;overflow:hidden;margin:8px 18px}
  .progress > div{height:100%;width:0;background:var(--primary);transition:width .25s}
  .controls{display:flex;gap:.6rem;justify-content:center;margin-top:10px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:10px;border:none;background:var(--primary);color:#fff;cursor:pointer;font-weight:700}
  .btn-outline{background:transparent;border:1px solid #ddd;color:var(--text);border-radius:10px}
  @media (max-width:420px){ .bead.am{width:30px;height:30px} .bead.pn{width:38px;height:38px} .bead.credo{width:38px;height:38px} }
</style>
</head>
<body>
  <header class="header">
    <button class="btn-back" onclick="history.back()">← Voltar</button>
    <div style="font-weight:700;display:flex;align-items:center;gap:.6rem"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>Terço da Misericórdia</div>
  </header>

  <main class="page">
    <section class="card prayer-card" id="prayerCard" aria-live="polite">
      <h3 id="prayerTitle">Oração atual</h3>
      <p id="prayerText">Carregando...</p>
      <div class="prayer-meta" id="prayerMeta"></div>
    </section>

    <section id="misterio" class="misterio" aria-hidden="true">
      <strong id="misterioTitulo"></strong>
      <div id="misterioTexto"></div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:center;margin-bottom:10px">
        <div id="credoCross" class="bead credo" title="Ir para o Credo">✝</div>
      </div>

      <div id="beads" class="beads" aria-hidden="false"></div>

      <div class="progress" aria-hidden="false"><div id="progFill"></div></div>
      <div style="text-align:center;color:var(--muted);margin-top:6px" id="progLabel">0%</div>

      <div class="controls">
        <button id="nextBtn" class="btn">+ Próxima</button>
        <button id="resetBtn" class="btn-outline">Resetar</button>
      </div>
    </section>
  </main>

<script src="app.js"></script>
<script>
/* Terço da Misericórdia — completo (5 grandes + 50 pequenas) */
/* Oracoes */
const ORACOES = {
  sinal:'Em nome do Pai, do Filho e do Espírito Santo. Amém.',
  credo:'Creio em Deus Pai todo-poderoso, criador do céu e da terra; e em Jesus Cristo, seu único Filho, nosso Senhor... Amém.',
  pai_nosso:'Pai nosso, que estais nos céus, santificado seja o vosso nome; venha a nós o vosso reino... Amém.',
  ave:'Ave Maria, cheia de graça, o Senhor é convosco... Amém.',
  eterno_pai:'Eterno Pai, ofereço-vos o Corpo e o Sangue, a Alma e a Divindade de Nosso Senhor Jesus Cristo, em expiação pelos nossos pecados e pelos do mundo inteiro.',
  pela_paixao:'Pela sua dolorosa Paixão, tende misericórdia de nós e do mundo inteiro.',
  santo_deus:'Santo Deus, Santo Forte, Santo Imortal, tende misericórdia de nós e do mundo inteiro.',
  o_sangue_e_agua:'Ó Sangue e Água, que brotastes do Coração de Jesus como fonte de misericórdia para nós, confio em Vós. Amém.'
};

/* Sequência: sinal, pn init, am x1, credo, depois 5*(grande + 10*pequena), final (santo_deus + o_sangue) */
const SEQ = (function(){
  const s = [];
  s.push('sinal');          // 0
  s.push('credo');        // 1
  s.push('am_init');        // 2
  s.push('am_init');        // 3
  s.push('am_init');        // 4
  s.push('pn_init');          // 5
  for(let d=0; d<5; d++){
    s.push('grande'); // Eterno Pai (big)
    for(let i=0;i<10;i++) s.push('pequena'); // 10 pequenas
    s.push('gloria');
  }
  s.push('santo_deus');
  s.push('o_sangue');
  return s;
})();

const STORAGE = 'rosarium_misericordia_v1';
let state = { stepIndex: 0 };

/* helper: build beadSteps array (only 'grande' and 'pequena' and initial small AMs and pn_init are beads) */
function buildBeads(){
  const arr = [];
  for(let i=0;i<SEQ.length;i++){
    if(SEQ[i] === 'pn_init' || SEQ[i] === 'am_init' || SEQ[i] === 'grande' || SEQ[i] === 'pequena') {
      arr.push({step: i, type: SEQ[i]});
    }
  }
  return arr;
}

function load(){ try{ const raw = localStorage.getItem(STORAGE); if(raw) state = JSON.parse(raw);}catch(e){console.warn(e);} }
function save(){ try{ localStorage.setItem(STORAGE, JSON.stringify(state)); }catch(e){console.warn(e);} }

function render(){
  const step = SEQ[state.stepIndex];
  const titleEl = document.getElementById('prayerTitle');
  const textEl  = document.getElementById('prayerText');
  const metaEl  = document.getElementById('prayerMeta');
  const misterio = document.getElementById('misterio');
  const mTitulo  = document.getElementById('misterioTitulo');
  const mTexto   = document.getElementById('misterioTexto');

  misterio.style.display = 'none'; mTitulo.innerText = ''; mTexto.innerText = '';

  if(step === 'sinal'){
    titleEl.innerText = 'Sinal da Cruz'; textEl.innerText = ORACOES.sinal; metaEl.innerText = '';
  } else if(step === 'pn_init'){
    titleEl.innerText = 'Pai-Nosso (inicial)'; textEl.innerText = ORACOES.pai_nosso; metaEl.innerText = '';
  } else if(step === 'am_init'){
    titleEl.innerText = 'Ave-Maria (inicial)'; textEl.innerText = ORACOES.ave; metaEl.innerText = '';
  } else if(step === 'credo'){
    titleEl.innerText = 'Creio'; textEl.innerText = ORACOES.credo; metaEl.innerText = '';
  } else if(step === 'grande'){
    titleEl.innerText = 'Conta Grande'; textEl.innerText = ORACOES.eterno_pai;
    metaEl.innerText = `Dezena ${computeDezenaIndex(state.stepIndex)+1} de 5`;
  } else if(step === 'pequena'){
    titleEl.innerText = 'Conta Pequena'; textEl.innerText = ORACOES.pela_paixao;
    metaEl.innerText = `Ave-Maria ${countPequenasUpTo(state.stepIndex)} da dezena ${computeDezenaIndex(state.stepIndex)+1}`;
  } else if(step === 'gloria'){
    titleEl.innerText = 'Glória ao Pai'; textEl.innerText = 'Glória ao Pai. Amém.'; metaEl.innerText = '';
  } else if(step === 'santo_deus'){
    titleEl.innerText = 'Santo Deus'; textEl.innerText = ORACOES.santo_deus; metaEl.innerText = '';
  } else if(step === 'o_sangue'){
    titleEl.innerText = 'Ó Sangue e Água'; textEl.innerText = ORACOES.o_sangue_e_agua; metaEl.innerText = '';
  } else {
    titleEl.innerText = ''; textEl.innerText = ''; metaEl.innerText = '';
  }

  // show mystery only on 'grande' (which corresponds to Pai-Nosso that opens a decade)
  if(step === 'grande'){
    misterio.style.display = 'block';
    const info = { key:'misericordia', label:'Terço da Misericórdia' }; // no real mysteries here; keep label generic
    mTitulo.innerText = info.label + ' — ' + (computeDezenaIndex(state.stepIndex)+1) + 'º';
    mTexto.innerText = 'Reze as contas pedindo misericórdia pela humanidade.';
  }

  // beads render
  const container = document.getElementById('beads');
  container.innerHTML = '';
  const beadSteps = buildBeads();
  let lastFilled = -1;
  for(let j=0;j<=state.stepIndex;j++) if(SEQ[j]==='grande' || SEQ[j]==='pequena' || SEQ[j]==='pn_init' || SEQ[j]==='am_init') lastFilled = j;

  beadSteps.forEach((b, idx)=>{
    const div = document.createElement('div');
    div.className = 'bead ' + (b.type==='grande' || b.type==='pn_init' ? 'pn' : 'am');
    if(b.step <= lastFilled) div.classList.add('filled');
    div.title = `${b.type} — passo ${b.step+1}`;
    div.onclick = ()=> jumpTo(b.step);
    div.textContent = (b.type === 'grande' || b.type==='pn_init' ? 'P' : '');
    container.appendChild(div);
  });

  // progress
  const pct = Math.round(((state.stepIndex + 1) / SEQ.length) * 100);
  document.getElementById('progFill').style.width = pct + '%';
  document.getElementById('progLabel').innerText = pct + '%';

  // creed cross fill
  const cross = document.getElementById('credoCross');
  const creedIdx = SEQ.indexOf('credo');
  if(state.stepIndex > creedIdx) cross.classList.add('filled'); else cross.classList.remove('filled');
}

function computeDezenaIndex(globalIndex){
  // counts how many 'grande' before or at this index
  let count = 0;
  for(let i=0;i<=globalIndex;i++) if(SEQ[i] === 'grande') count++;
  return Math.max(0, count-1); // 0-based
}
function countPequenasUpTo(globalIndex){
  // counts pequenas in current dezena up to this index
  let count = 0;
  // find last 'grande' index before or at globalIndex
  let lastGrande = -1;
  for(let i=0;i<=globalIndex;i++) if(SEQ[i]==='grande') lastGrande = i;
  for(let i = lastGrande+1; i<=globalIndex; i++) if(SEQ[i] === 'pequena') count++;
  return count;
}

function onTercoComplete(){
  // registra no calendário usando a função global do app.js
  try {
    if (typeof registrarTercoRezados === 'function') {
      registrarTercoRezados('misericordia');
    } else if (window.Terco && window.Terco.record) {
      window.Terco.record('misericordia');
    } else {
      console.warn('Nenhuma função de registro disponível.');
    }
  } catch (e) {
    console.error('Erro ao registrar terço completo', e);
  }
}

function next(){
  if(state.stepIndex >= SEQ.length -1){
    alert('Terço completo — Glória a Deus!');
    
    // registrar antes do reset
    onTercoComplete();
    
    setTimeout(() => {
      state = { stepIndex: 0 };
      save();
      render();
    }, 750);
    
    return;
  }
  state.stepIndex++;
  save();
  render();
}

function reset(){
  if(!confirm('Resetar Terço da Misericórdia?')) return;
  state = { stepIndex: 0 }; save(); render();
}

function jumpTo(global){
  if(global < 0 || global >= SEQ.length) return;
  state.stepIndex = global; save(); render();
}

document.addEventListener('DOMContentLoaded', ()=>{
  try{ const raw=localStorage.getItem(STORAGE); if(raw) state = JSON.parse(raw);}catch(e){console.warn(e)}
  render();
  document.getElementById('nextBtn').addEventListener('click', next);
  document.getElementById('resetBtn').addEventListener('click', reset);
  document.getElementById('credoCross').addEventListener('click', ()=>{ jumpTo(SEQ.indexOf('credo')); });
});
</script>
</body>
</html>
